version: '3.8'

# Standard Stack - Optimized for minimal image sizes
# Total size: ~73MB (30x smaller than before!)
#
# Substrate: ~40MB (Alpine 5MB + binary 35MB)
# Registry:  ~18MB (Alpine 5MB + binary 13MB)
# Auth-hub:  ~15MB (Alpine 5MB + binary 10MB)

services:
  substrate:
    build:
      context: ${REPO_ROOT:-../..}
      dockerfile: substrate-deployments/base/Dockerfile.substrate
    image: substrate-hub:latest
    container_name: substrate
    ports:
      - "${SUBSTRATE_PORT:-4444}:4444"
    networks:
      - substrate-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4444"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    environment:
      - RUST_LOG=${RUST_LOG:-info}

  registry:
    build:
      context: ${REPO_ROOT:-../..}
      dockerfile: substrate-deployments/base/Dockerfile.registry
    image: registry:latest
    container_name: registry
    ports:
      - "${REGISTRY_PORT:-4445}:4445"
    networks:
      - substrate-net
    volumes:
      - registry-config:/config
      - registry-data:/data
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4445"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    environment:
      - RUST_LOG=${RUST_LOG:-info}

  auth-hub:
    build:
      context: ${REPO_ROOT:-../..}
      dockerfile: substrate-deployments/base/Dockerfile.auth-hub
    image: auth-hub:latest
    container_name: auth-hub
    ports:
      - "${AUTH_HUB_PORT:-4446}:4446"
    networks:
      - substrate-net
    volumes:
      - ${SECRETS_DIR:-./secrets}:/config/auth-hub
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4446"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - HOME=/config

  # Optional: Synapse CLI tool (only if you need it in a container)
  # Most users should install synapse on their host instead
  synapse:
    build:
      context: ${REPO_ROOT:-../..}
      dockerfile: substrate-deployments/base/Dockerfile.synapse
    image: synapse:latest
    container_name: synapse
    networks:
      - substrate-net
    profiles:
      - tools
    entrypoint: ["/bin/sh"]
    stdin_open: true
    tty: true

networks:
  substrate-net:
    driver: bridge

volumes:
  registry-config:
    driver: local
  registry-data:
    driver: local
